@import conf.Static
@import views.support.RenderClasses
@import model.{ApplicationContext, IdentityPage}
@import com.gu.identity.model.EmailNewsletters
@import services.EmailPrefsData
@import form.IdFormHelpers.nonInputFields
@import views.support.`package`.Seq2zipWithRowInfo
@import views.support.fragment.Switch._
@import views.support.fragment.ConsentBlock._
@import views.support.fragment.ConsentChannel._
@import common.LinkTo
@import controllers.editprofile.ProfileForms
@import _root_.utils.ConsentsJourneyType._

@(
    user: com.gu.identity.model.User,
    forms: ProfileForms,
    journey: AnyConsentsJourney,
    verifiedReturnUrl: String,
    idRequest: services.IdentityRequest,
    idUrlBuilder: services.IdentityUrlBuilder,
    emailPrefsForm: Form[EmailPrefsData],
    emailSubscriptions: List[String],
    availableLists: EmailNewsletters,
    consentHint: Option[String] = None,
    skin: Option[String] = None)(implicit request: RequestHeader, messages: play.api.i18n.Messages, context: model.ApplicationContext)

@selectAllCheckboxContent = {
    <div class="manage-account__switches">
        <ul class="manage-account__switches-head">
            <li>
                <label class="manage-account__switch manage-account__switch--@skin.getOrElse("default") manage-account__switch--no-box manage-account__switch--no-padding js-manage-account__check-allCheckbox u-h" data-link-name="mma switch : (consents - all)" data-wrapper="body">
                    <div class="manage-account__switch-content">
                        <input type="checkbox"/>
                        <div class="manage-account__switch-checkbox"></div>
                        <h3 class="manage-account__switch-title"></h3>
                    </div>
                </label>
            </li>
        </ul>
    </div>
}

@onlySubscribedToV1Newsletters = @{
    EmailNewsletters.all.subscriptions.filter { newsletter =>
        emailSubscriptions.contains(newsletter.listIdV1.toString)
    }
}

@channelStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @helper.repeatWithIndex(forms.privacyForm("consents"), min=1) { (consentField, index) =>
                @if(isUsersChannel(consentField, user)) {
                    <li>
                        @fragments.consentSwitch(consentField = consentField, skin = skin)(messages)
                    </li>
                }
            }
            </ul>
        </div>
    </form>
}

@channelStep = @{
    ConsentStep(
        name = "channels",
        title = "How else can we get in touch with you?",
        content = channelStepContent,
        show = channelsProvidedBy(user).nonEmpty
    )
}

@marketingStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @helper.repeatWithIndex(forms.privacyForm("consents"), min = 1) { (consentField, index) =>
                @if(!isChannel(consentField)) {
                    @if(index == 0) {
                        <li>
                            @fragments.consentSwitch(consentField, consentHint, skin = skin)(messages)
                        </li>
                    } else {
                        <li>
                            @fragments.consentSwitch(consentField, skin = skin)(messages)
                        </li>
                    }
                }
            }
            </ul>
        </div>
    </form>
}
@marketingConsentStep = @{
    ConsentStep(
        name = "marketing-consents",
        title = "Guardian products and services",
        content = marketingStepContent
    )
}

@emailRepermissionStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        @fragments.form.hidden(emailPrefsForm("htmlPreference"))
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @onlySubscribedToV1Newsletters.zipWithRowInfo.map { case (newsletter, row) =>
            <li>
                @fragments.newsletterSwitch(
                    emailPrefsForm,
                    emailSubscriptions,
                    newsletter = newsletter,
                    unchecked = true,
                    skin = skin
                )(nonInputFields, messages, request)
            </li>
            }
            </ul>
        </div>
    </form>
}
@emailRepermissionStep() = @{
    ConsentStep(
        name = "email",
        title = "Newsletters",
        help = List(
            ConsentStepHelpLegalText("The Guardianâ€™s newsletters include content from our website, which may be funded by outside parties. Newsletters may also display information about Guardian News and Media's other products, services or events (such as Guardian Jobs or Masterclasses), chosen charities or online advertisements.")
        ),
        content = emailRepermissionStepContent,
        show = onlySubscribedToV1Newsletters.nonEmpty
    )
}

@introStep = @{
    ConsentInfo(
        title = "Please select the emails you wish to receive",
        help = List(
            ConsentStepHelpLegalText(
                "You can change your preferences anytime by signing in, clicking My Account, then selecting Email Preferences."
            )
        )
    )
}

@if(skin == Some("gdpr-oi-campaign")) {
    <div class="identity-consent-hero identity-consent-hero--gdpr-oi-campaign">
        <h1 class="u-h">Stay with us</h1>
    </div>
}

<div class="identity-wrapper monocolumn-wrapper">
    <div class="js-errorHolder manage-account__errors"></div>
    @consentJourneyFragments.jsFallback(verifiedReturnUrl, idRequest, idUrlBuilder)
    <div class="identity-consent-journey @{skin.map(s => s"identity-consent-journey--$s" )} u-h" data-journey="@journey" data-component="identity-consent-journey-@journey">

        @defaultJourney = @{List(
            ConsentCustomHtml(
                title="select-all",
                content=selectAllCheckboxContent
            ),
            emailRepermissionStep,
            marketingConsentStep,
            channelStep
        )}

        @renderBlocks(
            journey match {
                case NewsletterConsentsJourney => {
                    List(
                        if(emailRepermissionStep.show) {
                            emailRepermissionStep
                        } else {
                            ConsentStep(
                                name = "error",
                                title = "Sorry",
                                content = Html("<p class=\"form__error\">Something went wrong updating your newsletters.</p>")
                            )
                        }
                    )
                }
                case ThankYouConsentsJourney => {
                    List(
                        ConsentBanner(
                            "Thank you"
                        ),
                        introStep
                    ) ++ defaultJourney

                }
                case GdprCampaignConsentsJourney => {
                    defaultJourney
                }
                case DefaultConsentsJourney => {
                    List(
                        introStep
                    ) ++ defaultJourney
                }
            }
        )

        <form class="identity-consent-journey__controls" method="POST" action="@idUrlBuilder.buildUrl("/complete-consents", idRequest)">
            <input type="hidden" name="returnUrl" value="@verifiedReturnUrl" />
            @views.html.helper.CSRF.formField
            <button
                type="submit"
                class="manage-account__button--icon manage-account__button @{skin.map(s => s"manage-account__button--$s" )}"
                data-link-name="consents : navigation : submit"
            >
                <div class="manage-account__button-flexwrap">
                    <span>Finish</span>
                    @fragments.inlineSvg("tick-button", "icon")
                </div>
            </button>
        </form>
    </div>

</div>
