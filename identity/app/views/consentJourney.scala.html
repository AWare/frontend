@import conf.Static
@import views.support.RenderClasses
@import model.{ApplicationContext, IdentityPage}
@import com.gu.identity.model.EmailNewsletters
@import services.EmailPrefsData
@import form.IdFormHelpers.nonInputFields
@import views.support.`package`.Seq2zipWithRowInfo
@import views.support.fragment.Switch._
@import views.support.fragment.ConsentStep
@import views.support.fragment.ConsentChannel._
@import conf.switches.Switches.IdentityShowCommunicationChannelConsents
@import common.LinkTo
@import controllers.editprofile.ProfileForms

@(
    user: com.gu.identity.model.User,
    forms: ProfileForms,
    journey: String,
    verifiedReturnUrl: String,
    idRequest: services.IdentityRequest,
    idUrlBuilder: services.IdentityUrlBuilder,
    emailPrefsForm: Form[EmailPrefsData],
    emailSubscriptions: List[String],
    availableLists: EmailNewsletters,
    consentHint: Option[String] = None)(implicit request: RequestHeader, messages: play.api.i18n.Messages, context: model.ApplicationContext)

@onlySubscribedToV1Newsletters = @{
    EmailNewsletters.all.subscriptions.filter { newsletter =>
        emailSubscriptions.contains(newsletter.listId.toString)
    }
}

@renderStep(step: ConsentStep, index: Option[Int] = None) = {
    @if(step.show) {
        <fieldset
            class="identity-wizard__step"
            data-wizard-step-name="@step.name"
            role="dialog"
            aria-labelledby="consentWizard@{step.name.capitalize}Title"
        >
            <legend id="consentWizard@{step.name.capitalize}Title" class="identity-title identity-title--page-title">@step.title</legend>
            <div class="identity-forms-wrapper">
                @if(step.help) {
                    <div class="identity-forms-wrapper__title">
                        @step.help.map(paragraph =>
                            Html(s"<p class='identity-title-explainer'>$paragraph</p>")
                        )
                        @if(index.contains(0)) {
                            <p class='identity-title-explainer'>
                                By continuing you are confirming that you are aged over 13.
                            </p>
                        }
                    </div>
                }
                <div class="identity-forms-wrapper__fields">
                    @step.content
                </div>
            </div>

        </fieldset>
    }
}
@renderSteps(steps:List[ConsentStep]) = @{
    steps.zipWithIndex.map{ case (element, index) => renderStep(element, Some(index)) }
}

@channelStepContent = {
    <div class="manage-account__switches">
        <ul>
        @communicationChannelsForUser(user).map((channel) =>
            Html(s"<li>${checkboxName(channel)}</li>")
        )
        </ul>
    </div>
}
@channelStep = @{
    ConsentStep(
        name = "channels",
        title = "How can we get in touch with you?",
        help = List("Besides email, are there any other ways you would like us to get in touch with you?"),
        content = channelStepContent,
        show = IdentityShowCommunicationChannelConsents.isSwitchedOn && communicationChannelsForUser(user).nonEmpty
    )
}

@consentStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @helper.repeatWithIndex(forms.privacyForm("consents"), min = 1) { (consentField, index) =>
                <li>
                    @if(index == 0) {
                        @fragments.consentSwitch(consentField, consentHint)(messages)
                    } else {
                        @fragments.consentSwitch(consentField)(messages)
                    }
                </li>
            }
            </ul>
        </div>
    </form>
}
@communicationConsentStep = @{
    ConsentStep(
        name = "consent",
        title = if(journey == "all") {
            "We need you to consent again to receiving communications from the Guardian"
        } else {
            "What would you like to hear about?"
        },
        help = List("Just take a couple of minutes to tell us what you’re interested in, so we can send you emails that we think you’ll find useful."),
        content = consentStepContent
    )
}

@emailRepermissionStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        @fragments.form.hidden(emailPrefsForm("htmlPreference"))
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @onlySubscribedToV1Newsletters.zipWithRowInfo.map { case (newsletter, row) =>
            <li>
                @fragments.newsletterSwitch(
                    emailPrefsForm,
                    emailSubscriptions,
                    newsletter = newsletter,
                    unchecked = true
                )(nonInputFields, messages, request)
            </li>
            }
            </ul>
        </div>
    </form>
}
@emailRepermissionStep() = @{
    ConsentStep(
        name = "email",
        title = "Your existing newsletters",
        help = List("You were receiving the following newsletters, tick their boxes again to confirm you want to keep receiving them."),
        content = emailRepermissionStepContent,
        show = onlySubscribedToV1Newsletters.nonEmpty
    )
}

@emailSignupStepContent = {
    <form novalidate action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        @fragments.form.hidden(emailPrefsForm("htmlPreference"))

        <div class="manage-account__switches">
        @fragments.emailListCategories(emailPrefsForm,availableLists,emailSubscriptions,true)(request, messages)
        </div>
    </form>
}
@emailSignupStep() = @{
    ConsentStep(
        name = "email-signup",
        title = "Your newsletters",
        help = List("Our regular newsletters help you get closer to our quality, independent journalism. You can tailor your experience by picking the issues and topics that interest you below."),
        content = emailSignupStepContent,
        show = true
    )
}

@emailRepermissionOrSignupStep = @{
    if(emailRepermissionStep.show) {
        emailRepermissionStep()
    } else {
        emailSignupStep()
    }
}

@getStepsForJourney(journey: String) = @{
    journey match {
        case "newsletters" => {
            List(
                if(emailRepermissionStep.show) {
                    emailRepermissionStep
                } else {
                    ConsentStep(
                        name = "error",
                        title = "Sorry",
                        content = Html("<p class=\"form__error\">Something went wrong updating your newsletters.</p>")
                    )
                }
            )
        }
        case "all" => {
            List(
                communicationConsentStep,
                emailRepermissionStep,
                channelStep
            )
        }
        case _ => {
            List(
                communicationConsentStep,
                emailRepermissionOrSignupStep,
                channelStep
            )
        }
    }
}

<div class="identity-wrapper monocolumn-wrapper identity-wrapper--with-wizard">

    <div class="js-errorHolder manage-account__errors"></div>

    <noscript>
        <div class="form__error">
            <p>
                Setting your preferences requires a browser with Javascript enabled.
            </p>
            <p>
                Please consider upgrading to one of our <a href="@LinkTo{/help/recommended-browsers}">recommended browsers</a>. If you need more help please <a href="@LinkTo{/info/tech-feedback}">contact us</a>.
            </p>
        </div>
    </noscript>

    <div class="identity-wizard identity-wizard--consent u-h" data-journey="@journey" data-component="identity-consent-journey-@journey">

        @renderSteps(getStepsForJourney(journey))

        <form class="identity-wizard__controls" method="POST" action="@idUrlBuilder.buildUrl("/complete-consents", idRequest)">
            <button
                type="button"
                data-link-name="consents : navigation : prev"
                class="identity-consent-wizard-button-back identity-consent-wizard__revealable manage-account__button--round manage-account__button js-identity-wizard__prev"
            >
                <span class="u-h">Previous</span>
                @fragments.inlineSvg("arrow-left-stem", "icon")
            </button>
            <div class="identity-consent-wizard__revealable identity-consent-wizard-counter">
            </div>
            @views.html.helper.CSRF.formField
            <input type="hidden" name="returnUrl" value="@verifiedReturnUrl" />
            <button
                type="button"
                data-link-name="consents : navigation : next"
                class="manage-account__button--icon manage-account__button js-identity-consent-wizard__next"
            >
                <div class="manage-account__button-flexwrap">
                    <span>Next</span>
                    @fragments.inlineSvg("arrow-right", "icon")
                </div>
            </button>
            <button
                type="submit"
                class="manage-account__button--icon manage-account__button js-identity-consent-wizard__complete"
                data-link-name="consents : navigation : submit"
            >
                <div class="manage-account__button-flexwrap">
                    <span>Finish</span>
                    @fragments.inlineSvg("tick-button", "icon")
                </div>
            </button>
        </form>
    </div>

</div>
