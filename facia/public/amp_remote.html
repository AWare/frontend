
<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <script>
        (function() {
            var v = location.search.substr(1);
            if (!(/^\d+(-canary)?$/.test(v))) return;
            var u = 'https://3p.ampproject.net/'+encodeURIComponent(v)+'/f.js';
            document.write('<script'+' src="'+encodeURI(u)+'"><'+'/script>');
        })();
    </script>
</head>
<body style="margin:0">
<div id="c" style="position:absolute;top:0;left:0;bottom:0;right:0;">

    <script>
        // Duplicating the Guardian config object in the real site
        var guardian = {} ;

        function loadKrux() {
            var krux = document.createElement('script');
            krux.setAttribute("class", "kxct");
            krux.setAttribute("data-id", "JVZiE3vn");
            krux.setAttribute("data-timing", "async");
            krux.setAttribute("data-version", "1.9");
            krux.setAttribute("type", "text/javascript");

            krux.innerHTML = "window.Krux||((Krux=function(){Krux.q.push(arguments)}).q=[]); " +
            "(function(){ " +
            "var k=document.createElement('script');k.type='text/javascript';k.async=true; " +
            "var m,src=(m=location.href.match(/\bkxsrc=([^&]+)/))&&decodeURIComponent(m[1]); " +
            "k.src = /^https?:\\/\\/([a-z0-9_\\-\\.]+\\.)?krxd\\.net(:\\d{1,5})?\\//i.test(src) ? src : src === 'disable' ? '' : " +
            "(location.protocol==='https:'?'https:':'http:')+'//cdn.krxd.net/controltag?confid=JVZiE3vn' ; " +
            "var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(k,s); }());";

            document.body.appendChild(krux);
        }

        function exposeMetaDataForKrux(config) {
            guardian = { 'config' : {
                'page' : {
                    'pageId' : config.targeting.url,
                    'edition' : config.targeting.edition,
                    'seriesId' : config.targeting.se, //series isn't in the Krux output
                    'contentType' : config.targeting.ct,
                    'keywordIds' : config.targeting.keywordIds,
                    'authorIds' : config.targeting.authorIds,
                    'blogIds' : config.targeting.bl // blogs isn't recognised by Krux scraper
                }
            }

            };
        }

        function attachAdTestParam(config) {
            var url = (window.location != window.parent.location)
                ? document.referrer
                : document.location;

            var fragments = url.split('adtest=');
            if (fragments.length === 2) {
                config.targeting.at = fragments[1]
            }
            return config;
        }

        function attachKruxSegments(config) {
            if (localStorage.getItem('kxsegs') !== null) {
                var kxSegList = localStorage.getItem('kxsegs').split(',');

                if (kxSegList.length > 0) {
                    config.targeting.x = kxSegList;
                }
            }

            return config;
        }

        function configIsValid(config) {
            return config && config.targeting;
        }

        function isMasterIframe(config) {
            return window.context.isMaster && config.type == 'doubleclick';
        }

        // since draw3p is going to fail, we just do it here:
        if (true) {
            console.log('Is this working?');
            var config = {
                'targeting': {
                    'url' : 'hello/there',
                    'edition' : 'uk',
                    'se' : 'series/tag',
                    'ct' : 'article',
                    'p' : 'amp',
                    'keywordIds' : 'keyword/a,keyword/b',
                    'k' : 'a,b',
                    'co' : 'johndoe',
                    'bl' : 'commentisfree/testing',
                    'authorIds' : 'contributor/johndoe'
                }
            }
            exposeMetaDataForKrux(config);
            loadKrux();
        }


        // this is the big AMP callback
        draw3p(function (config, done) {

            if (configIsValid(config) && isMasterIframe(config)) {
                exposeMetaDataForKrux(config);
                loadKrux();
            }

            if (configIsValid(config)) {
                var configWithAdTestParam = attachAdTestParam(config);
                var result = attachKruxSegments(configWithAdTestParam);
            } else {
                done();
            }

            done(result);
        })</script>
</div>
<script>if (window.docEndCallback) window.docEndCallback()</script>
</body>
</html>
