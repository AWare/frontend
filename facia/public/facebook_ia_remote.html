<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <script async class="kxct" data-id="J_RxuxWJ" data-timing="async" data-version="1.9" src="https://cdn.krxd.net/controltag?confid=J_RxuxWJ"></script>
    <script async src="https://www.googletagservices.com/tag/js/gpt.js"></script>
</head>
<body style="margin:0">
    <div id="ad-slot-1"></div>
    <script>
    (function (window, document, undefined) {
        var settings = parseParameters(window.location);
        var googletag = window.googletag = window.googletag || { cmd: [] };

        window.Krux || ((window.Krux=function(){Krux.q.push(arguments)}).q=[]);

        init();

        function parseParameters(location) {
            var params = {};
            var args = location.hash.substr(1).split('&');
            var i, argsLength = args.length;

            for (i = 0; i < argsLength; ++i) {
                var arg = args[i].split("=");
                var argName = decodeURIComponent(arg[0]);
                var argValue = decodeURIComponent(arg[1]);

                if (params[argName] !== undefined) {
                    params[argName] += ',' + argValue;
                } else {
                    params[argName] = argValue;
                }
            }

            return params;
        }

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        function exposeMetaDataForKrux() {
            window.config = {
                pageId: settings.url,
                edition: toTitleCase(settings.edition),
                seriesId: settings.se,
                contentType: toTitleCase(settings.ct),
                keywordIds: settings.keywordIds,
                keywords: settings.k.split(',').map(toTitleCase),
                authorIds: settings.authorIds,
                blogIds: settings.bl,
                referrer: 'facebook-ia',
                section: settings.section
            };
        }

        function buildSegments(slot) {
            var kruxSegments = localStorage.getItem('kxsegs');
            if (kruxSegments !== null) {
                slot.setTargeting('x', kruxSegments.split(','));
            }
        }

        function buildTargetSize(sizes) {
            return sizes
            .split(',')
            .map(function (size) {
                return size === 'fluid' ? 'fluid' : size.split('x')
            });
        }

        function buildCustomTargeting(slot) {
            var attr, i, key, len, match, value;
            var ref = Object.keys(settings);
            for (i = 0, len = ref.length; i < len; i++) {
                attr = ref[i];
                match = attr.match(/^data-ad-target-(.+)$/);
                if (match != null) {
                    key = match[1];
                    value = settings[attr].split(',');
                    slot.setTargeting(key, value);
                }
            }
        }

        function buildAdtestTargeting(slot) {
            if (settings.at) {
                slot.setTargeting('at', settings.at);
            }
        }

        function insertAd() {
            var size = settings['data-ad-size'];
            var adUnitName = settings['data-ad-unit'];

            googletag.cmd.push(function() {
                googletag.pubads().enableAsyncRendering();
                googletag.pubads().collapseEmptyDivs();
                googletag.enableServices();

                Krux(function () {
                    var slot = googletag.defineSlot('/59666047/' + adUnitName, buildTargetSize(size), 'ad-slot-1');
                    buildCustomTargeting(slot);
                    buildAdtestTargeting(slot);
                    buildSegments(slot);
                    slot.addService(googletag.pubads());
                    googletag.display('ad-slot-1');
                });
            });
        }

        function init() {
            exposeMetaDataForKrux();
            insertAd();
        }
    }(window, window.document));
    </script>
    <script>if (window.docEndCallback) window.docEndCallback()</script>
</body>
</html>
