@(article: content.Article)
@import fragments._

<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />

    <title>@article.headline</title>
        
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">

    <link rel="stylesheet" media="screen" type="text/css" href="http://1.gu-pasteup.appspot.com/css/pasteup.css" />
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/grid.responsive.css")">
    
    <style>
        /* mildly arbitrary breakpoints */
        @@media screen and (min-width: 320px) {
            #container {
                width: 90%;
            }
        }
        @@media screen and (min-width: 650px) {
            #container {
                width: 640px;
            }
        }
        @@media screen and (min-width: 976px) {
            #container {
                width: 960px;
            }
        }
    </style>

    <script>
        var guardian = {};

        /* utility functions for low-level dom manipulation */
        guardian.util = {

            /* native method to add a class */
            add_class: function(elm, classname) {
                var re = new RegExp(classname, 'g');
                if(!elm.className.match(re)){
                    elm.className += ' ' + classname;
                }
            },

            /* native method to remove a class */
            remove_class: function(elm, classname) {
                var re = new RegExp(classname, 'g');
                elm.className = elm.className.replace(re, '');
            },

            /* convenience method to swap one class for another */
            swap_class: function(elm, class_to_remove, class_to_add) {
                this.remove_class(elm, class_to_remove);
                this.add_class(elm, class_to_add);
            }

        };

        // needs work (and css is separate)
        guardian.breakpoints = {
            base: 400, // mobile
            median: 650, // tablet
            extended: 900 // desktop
            
            // bbc uses:
                // mobile = default
                // tablet = 640
                // desktop = 976
        };

        guardian.images_upgraded = false;

        guardian.test_for_hires_images = function() {
            console.log("testing for width");
            // load higher-res images if available
            var width = window.innerWidth || document.body.offsetWidth || 0;
            if (width >= guardian.breakpoints.median && !guardian.images_upgraded) {
                guardian.upgrade_images();
            }
        };

        guardian.upgrade_images = function(){
            var images = document.querySelectorAll('img.upscalable');
            var l = images.length;
            if (l > 0) {
                console.log("scaled up");
                for (i=0; i<l; i++) {
                    var img = images[i];
                    img.src = img.dataset['hisrc'];
                }
                guardian.images_upgraded = true;
            }
        };

        guardian.show_screen_size = function(event) {
            guardian.debug = {
                screenHeight: screen.height,
                screenWidth: screen.width,
                windowWidth: window.innerWidth || document.body.offsetWidth || 0,
                windowHeight: window.innerHeight || document.body.offsetHeight || 0
            }
            for (var key in guardian.debug) {
                document.getElementById(key).innerText = guardian.debug[key];
            }
        };

        // used to track window resize events so we don't fire a million of them
        guardian.did_resize;

        // see http://ejohn.org/blog/learning-from-twitter/
        // seems to fire on page load in chrome, nowhere else
        window.onresize = function(){
            guardian.did_resize = true;
        };

        setInterval(function(){
            if (guardian.did_resize) {
                guardian.did_resize = false;
                guardian.test_for_hires_images();
            }
        }, 250);

        // ugly, but should work crossbrowser
        /*
        document.onreadystatechange = function () {
            if (document.readyState == "complete") {
                guardian.test_for_hires_images();
            }
        }
        */

        /* the following adapted from https://github.com/jquery/jquery/blob/master/src/core.js */
        
        // Mozilla, Opera and webkit nightlies currently support this event
        if ( document.addEventListener ) {
            document.addEventListener( "DOMContentLoaded", DOMContentLoaded, false );
        // If IE event model is used
        } else if ( document.attachEvent ) { 
            document.attachEvent( "onreadystatechange", DOMContentLoaded );
        }

        if ( document.addEventListener ) {
            DOMContentLoaded = function() {
                document.removeEventListener( "DOMContentLoaded", DOMContentLoaded, false );
                //jQuery.ready(); // do something here
            };

        } else if ( document.attachEvent ) {
            DOMContentLoaded = function() {
                if ( document.readyState === "complete" ) {
                    document.detachEvent( "onreadystatechange", DOMContentLoaded );
                    //jQuery.ready(); // do something here
                }
            };
        }



    </script>

</head>

<body>

    <div id="container">

        <div class="line">

            <div class="unit size2of3">
                @fragments.headline(article.headline)

                @article.images.find( i => i.rel == "alt-size" && i.width < 250 && i.width > 140).map{ image =>
                    <img style="width: 100%;" class="upscalable" src="@image.url" data-hisrc='@article.images.find(_.rel == "body").map { full => @full.url }' />
                }

                @Html(article.body)
            </div>

            <div class="unit size1of3 lastUnit">
                <ul>
                @article.tags.map{ tag =>
                    <li>@fragments.formatTags(tag)</li>
                }
                </ul>
            </div>
        </div>

    </div>

    <div id="debug">
        <strong>debug info</strong>
        <ul>
            <li>Screen height: <span id="screenHeight"></span></li>
            <li>Screen width: <span id="screenWidth"></span></li>
            <li>Window height: <span id="windowHeight"></span></li>
            <li>Window width: <span id="windowWidth"></span></li>
        </ul>
        <button onclick="guardian.show_screen_size();">Update sizes</button>
    </div>
    
</body>
</html>
