@(item: model.MetaData, curlPaths: Map[String, String] = Map())(implicit request: RequestHeader)
@import conf.Switches._
@import conf.Static
@import conf.Configuration

<script>
    (function (isModern, win, doc) {
        if (!isModern) { return false; }
        @if(FontSwitch.isSwitchedOn) {
            @Html(Static.js.loadFonts)
        }
    })(guardian.isModernBrowser, window, document);
</script>

@if(mvt.JspmTest.isParticipating || item.section == "crosswords") {
    @bootSystemJs()
} else {
    @bootCurl()
}

@bootCurl() = {
    <script>
        var curl = {
            baseUrl: '@{Configuration.assets.path}javascripts',
            apiName: 'require',
            paths: {
                @curlPaths.map { case (module, path) =>
                    '@module': '@Static(path)',
                }
                core:                       '@Static("javascripts/core.js")',
                'facebook.js':              '//connect.facebook.net/en_US/all.js',
                'foresee.js':               'vendor/foresee/20150703/foresee-trigger.js',
                'googletag.js':             '@{Configuration.javascript.config("googletagJsUrl")}',
                'ophan/ng':                 '@{Configuration.javascript.config("ophanJsUrl")}',
                stripe:                     '@Static("javascripts/vendor/stripe/stripe.min.js")',
                text:                       'text', // noop
                inlineSvg:                  'inlineSvg', // noop
                zxcvbn:                     '@Static("javascripts/components/zxcvbn/zxcvbn.js")',
                'bootstraps/accessibility': '@Static("javascripts/bootstraps/accessibility.js")',
                'bootstraps/app':           '@Static("javascripts/bootstraps/app.js")',
                'bootstraps/commercial':    '@Static("javascripts/bootstraps/commercial.js")',
                'bootstraps/creatives':     '@Static("javascripts/bootstraps/creatives.js")',
                'bootstraps/dev':           '@Static("javascripts/bootstraps/dev.js")',
                'bootstraps/preferences':   '@Static("javascripts/bootstraps/preferences.js")',
                'bootstraps/facia':         '@Static("javascripts/bootstraps/facia.js")',
                'bootstraps/football':      '@Static("javascripts/bootstraps/football.js")',
                'bootstraps/image-content': '@Static("javascripts/bootstraps/image-content.js")',
                'bootstraps/membership':    '@Static("javascripts/bootstraps/membership.js")',
                'bootstraps/sudoku':        '@Static("javascripts/bootstraps/sudoku.js")',
                'bootstraps/video-player':  '@Static("javascripts/bootstraps/video-player.js")',
                'bootstraps/article': '@Static("javascripts/bootstraps/article.js")',
                'bootstraps/liveblog': '@Static("javascripts/bootstraps/liveblog.js")',
                'bootstraps/trail': '@Static("javascripts/bootstraps/trail.js")',
                'bootstraps/gallery': '@Static("javascripts/bootstraps/gallery.js")',
                'bootstraps/profile': '@Static("javascripts/bootstraps/profile.js")'
            }
        };

        @Html(Static.js.curl)

        require([
            'core',
            'domReady!'
        ])
            .next([
                'raven'
            ], function(
                raven
            ) {

                raven.config(
                    'http://' + guardian.config.page.sentryPublicApiKey + '@@' + guardian.config.page.sentryHost,
                    {
                        whitelistUrls: [
                            /localhost/, @* will not actually log errors, but `shouldSendCallback` will be called *@
                            /assets\.guim\.co\.uk/,
                            /ophan\.co\.uk/
                        ],
                        tags: {
                            edition:        guardian.config.page.edition,
                            contentType:    guardian.config.page.contentType,
                            revisionNumber: guardian.config.page.revisionNumber,
                            loaderType:     'Curl'
                        },
                        dataCallback: function(data) {
                            if (data.culprit) {
                                data.culprit = data.culprit.replace(/\/[a-z\d]{32}(\/[^\/]+)$/, '$1');
                            }
                            data.tags.origin = (/j.ophan.co.uk/.test(data.culprit)) ? 'ophan' : 'app';
                            return data;
                        },
                        shouldSendCallback: function(data) {
                            @if(play.Play.isDev()) {
                                console.error(data);
                            }

                            return @conf.Switches.DiagnosticsLogging.isSwitchedOn &&
                                Math.random() < 0.2 &&
                                @{!play.Play.isDev()}; @* don't actually notify sentry in dev mode*@
                        }
                    }
                ).install();

                require([
                    'common/utils/config',
                    'common/modules/experiments/ab',
                    'common/modules/ui/images',
                    'common/modules/ui/lazy-load-images'
                ], function (
                    config,
                    ab,
                    images,
                    lazyLoadImages
                ) {

                    if (guardian.isModernBrowser) {
                        ab.segmentUser();
                        ab.run();
                    }
                    if(guardian.config.page.isFront) {
                        if(!document.addEventListener) { // IE8 and below
                            window.onload = images.upgradePictures;
                        }
                    }
                    lazyLoadImages.init();
                    images.upgradePictures();
                    images.listen();

                    // Preference pages are served via HTTPS for service worker support.
                    // These pages must not have mixed (HTTP/HTTPS) content, so
                    // we disable ads (until the day comes when all ads are HTTPS).
                    if (! config.page.isPreferencesPage) {
                        require(['bootstraps/commercial'], raven.wrap(
                            { tags: { feature: 'commercial' } },
                            function (commercial) {
                                commercial.init();
                            }
                        ));
                    }

                    if (guardian.isModernBrowser) {
                        @if(play.Play.isDev()) {
                            require(['bootstraps/dev'], function (devmode) { devmode.init(); });
                        }

                        require(['bootstraps/app'], function(bootstrap) {
                            bootstrap.go();
                        });
                    }

                });

                @membershipAccess()

            });
    </script>
}

@bootSystemJs() = {

    <script>
        @Html(Static.js.systemJsSetupFragment)

        // Bracket notation for IE8 (import is reserved)
        System['import']('core')
        .then(function(){
            return System['import']('raven');
        })
        .then(function(raven) {
            raven.config(
                'http://' + guardian.config.page.sentryPublicApiKey + '@@' + guardian.config.page.sentryHost,
                {
                    whitelistUrls: [
                        /localhost/, @* will not actually log errors, but `shouldSendCallback` will be called *@
                        /assets\.guim\.co\.uk/,
                        /ophan\.co\.uk/
                    ],
                    tags: {
                        edition:        guardian.config.page.edition,
                        contentType:    guardian.config.page.contentType,
                        revisionNumber: guardian.config.page.revisionNumber,
                        loaderType:     'SystemJs'
                    },
                    dataCallback: function(data) {
                        if (data.culprit) {
                            data.culprit = data.culprit.replace(/\/[a-z\d]{32}(\/[^\/]+)$/, '$1');
                        }
                        data.tags.origin = (/j.ophan.co.uk/.test(data.culprit)) ? 'ophan' : 'app';
                        return data;
                    },
                    shouldSendCallback: function(data) {
                        @if(play.Play.isDev()) {
                            console.error(data);
                        }

                        return @conf.Switches.DiagnosticsLogging.isSwitchedOn &&
                            Math.random() < 0.2 &&
                            @{!play.Play.isDev()}; @* don't actually notify sentry in dev mode*@
                    }
                }
            ).install();

            // Safe to depend on Lodash because it's part of core
            System['import']('common/utils/_').then(function (_) {
                var importAll = function (moduleIds) {
                    return Promise.all(_(moduleIds)
                        .map(function(module){ return System['import'](module); })
                        .value());
                };

                importAll([
                    'common/utils/config',
                    'common/modules/experiments/ab',
                    'common/modules/ui/images',
                    'common/modules/ui/lazy-load-images']).then(function(values) {
                    var config = values[0];
                    var ab = values[1];
                    var images = values[2];
                    var lazyLoadImages = values[3];

                    ab.segmentUser();
                    ab.run();
                    if(guardian.config.page.isFront) {
                        if(!document.addEventListener) { // IE8 and below
                            window.onload = images.upgradePictures;
                        }
                    }
                    lazyLoadImages.init();
                    images.upgradePictures();
                    images.listen();

                    if (config.switches.commercial && !config.page.isPreferencesPage) {
                        System['import']('bootstraps/commercial').then(raven.wrap(
                            { tags: { feature: 'commercial' } },
                            function (commercial) {
                                commercial.init();
                            }
                        ));
                    }

                    if (guardian.isModernBrowser) {
                        @if(play.Play.isDev()) {
                            System['import']('bootstraps/dev').then(function (devmode) { devmode.init(); });
                        }

                        System['import']('bootstraps/app').then(function(app) {
                            app.go();
                        });
                    }

                    @if(item.section == "crosswords") {
                        System['import']('es6/bootstraps/crosswords').then(function (crosswords) {
                            crosswords.default.init();
                        });

                        System['import']('es6/projects/common/modules/crosswords/thumbnails').then(function (crosswordThumbnails) {
                            crosswordThumbnails.default.init();
                        });
                    }
                });
            });


            @membershipAccess()

        });
    </script>
}

@membershipAccess() = {
    @for(membershipAccess <- item.membershipAccess if item.requiresMembershipAccess) {
        (function(isModern, membershipUrl, membershipAccess, win) {
            @Html(Static.js.membership)
        }(guardian.isModernBrowser, "@Configuration.id.membershipUrl", "@membershipAccess", window));
    }
}
