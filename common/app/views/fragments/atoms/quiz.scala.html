@import _root_.quiz.form.{QuizResults, playForm}
@import _root_.quiz.{postUrl, Question, Answer}
@import views.html.fragments.inlineSvg

@(quiz: model.content.Quiz, maybeResults: Option[QuizResults], showResults: Boolean, sharelinks: Seq[model.ShareLink])

@if(showResults) {
    <h2>@quiz.title</h2>
}
<form action="@postUrl(quiz)" method="POST">

    <ol class="quiz @{if (showResults) "quiz--results" else "quiz--questions"}">
        @quiz.content.questions.map { (question) =>
            @renderQuestion(question, playForm(s"answers[${question.id}]"), maybeResults.flatMap(_.getAnswerFor(question)))
        }
    </ol>

    @maybeResults.map { results =>
        @renderEndMessage(results)
    }.getOrElse {
        <button class="button" type="submit">Submit answers</button>
    }

</form>

@renderEndMessage(results: QuizResults) = {
    <div class="quiz__end-message">
        <div class="quiz__score-message">
            You got
            <span class="quiz__score">@results.score/@quiz.content.questions.size</span>
        </div>
        @results.resultGroup.map { resultGroup =>
            <div class="quiz__bucket-message">@resultGroup.title</div>
        }
        <div class="quiz__share">
            <div class="quiz__share__cta">Share your results</div>
            @fragments.social(sharelinks)
        </div>
    </div>
}

@renderQuestion(question: Question, field: play.api.data.Field, maybeInputAnswer: Option[Answer]) = {
    <li class="quiz__question
        @{ if (showResults) {
            s"quiz__question--${if(maybeInputAnswer.isEmpty) "without-response" else "with-response" }"
          }
        }">
        <span class="quiz__question__label">@question.text</span>

        <div class="quiz__question__rows">
            @question.answers.map( answer => {
                if(showResults) {
                    val isCorrect = maybeResults.exists(_.isCorrectAnswer(question, answer))
                    renderAnswerWithResponse(question, answer, isCorrect, maybeInputAnswer)
                } else {
                    renderAnswer(question, answer)
                }
            })
        </div>

    </li>
}

@renderAnswer(question: Question, answer: Answer) = {
    <div class="quiz__answer">
        <label for="answer-@{answer.id}" class="quiz__answer__label">
            <input type="radio"
                name="answers[question-@{question.id}]"
                id="answer-@{answer.id}"
                value="@{answer.id}"
                class="quiz__answer__input">

            <span class="quiz__answer__text">@{answer.text}</span>
        </label>
    </div>
}

@renderAnswerWithResponse(question: Question, answer: Answer, isAnswerCorrect: Boolean, maybeInputAnswer: Option[Answer]) = {
    <div class="quiz__answer @{
            if(isAnswerCorrect) "quiz__answer--correct" else "quiz__answer--incorrect"
        } @{
            if(maybeInputAnswer.exists(_.equals(answer))) "quiz__answer--selected"
        }">
        <label class="quiz__answer__label">

            @maybeInputAnswer.map { inputAnswer =>
                @if(inputAnswer.equals(answer)) {
                    <span class="quiz__answer__icon">
                        @if(isAnswerCorrect) {
                            @inlineSvg("tick", "icon")
                        } else {
                            @inlineSvg("cross", "icon")
                        }
                    </span>
                }
            }
            <span class="quiz__answer__text">@{answer.text}</span>
            @maybeInputAnswer.map { inputAnswer =>
                @if(answer.revealText.isDefined && isAnswerCorrect && inputAnswer.equals(answer)) {
                    <span class="quiz__answer__reveal-text">@answer.revealText</span>
                }
            }
        </label>
    </div>
}
