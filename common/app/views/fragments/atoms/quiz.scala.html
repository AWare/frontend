@import _root_.quiz.form.{QuizResults, playForm}
@import _root_.quiz.{postUrl, Question, Answer}
@import views.html.fragments.inlineSvg

@(quiz: model.content.Quiz, maybeResults: Option[QuizResults])

@if(maybeResults.isDefined) {
    <h2>@quiz.title</h2>
}
<form action="@postUrl(quiz)" method="POST" class="from-content-api quiz @{if (maybeResults.isDefined) "quiz--results" else "quiz--questions"}">

    <ol>
        @quiz.content.questions.zipWithIndex.map { case (question, questionIndex) =>
            @renderQuestion(question, questionIndex, playForm(s"answers[$questionIndex]"))
        }
    </ol>

    @maybeResults.map { results =>
        @renderEndMessage(results)
    }.getOrElse {
        <button class="button" type="submit">Submit answers</button>
    }

</form>

@renderEndMessage(results: QuizResults) = {
    <div class="quiz__end-message">
        <div class="quiz__score-message">
            You got
            <span class="quiz__score">@results.score/@quiz.content.questions.size</span>
        </div>
        @results.resultGroup.map { resultGroup =>
            <div class="quiz__bucket-message">@resultGroup.title</div>
        }
        <div class="quiz__share">
            <div class="quiz__share__cta">Challenge your friends</div>
            <a class="quiz__share__action quiz__share__action--facebook"
                data-link-name="social results : facebook"
                href=""
                target="_blank"
                title="facebook">
                <i class="quiz__share__action__svg--facebook quiz__share__action__svg"></i>
            </a>
            <div class="quiz__share__gap"></div>
            <a class="quiz__share__action quiz__share__action--twitter"
                data-link-name="social results : twitter"
                href=""
                target="_blank"
                title="twitter">
                <i class="quiz__share__action__svg--twitter quiz__share__action__svg"></i>
            </a>
        </div>
    </div>
}

@renderQuestion(question: Question, questionIndex: Int, field: play.api.data.Field) = {
    <li class="quiz__question" value="@{questionIndex+1}">
        <span class="quiz__question__legend">@question.text</span>

        @question.answers.zipWithIndex.map { case (answer, answerIndex) =>
            @{
                val maybeInputAnswer = maybeResults.flatMap(_.getAnswerFor(question))
                val isAnswerCorrect = maybeResults.exists(_.isCorrectAnswer(question, answer))
                renderAnswer(question, answer, questionIndex, answerIndex, isAnswerCorrect, maybeInputAnswer)
            }
        }

    </li>
}

@renderAnswer(question: Question, answer: Answer, questionIndex: Int, answerIndex: Int, isAnswerCorrect: Boolean, maybeInputAnswer: Option[Answer]) = {
    <div class="quiz__question__answer-row">
        <label for="question-@questionIndex-answer-@answerIndex"
            class="@{
                (
                    Seq("quiz__answer") ++
                    maybeResults
                        .map(x => {
                            Seq(
                                "quiz__answer--question-has-submission",
                                s"quiz__answer--${if(isAnswerCorrect) { "correct" } else { "incorrect" }}",
                                maybeInputAnswer
                                    .map { inputAnswer => {
                                        val isChosen = inputAnswer.equals(answer)
                                        if(isChosen) {
                                            s"quiz__answer--${if(isAnswerCorrect) { "correct" } else { "incorrect" }}--is-chosen"
                                        } else ""
                                    } }
                                    .getOrElse(if (isAnswerCorrect) { "quiz__answer--correct--not-answered" } else Nil))
                        })
                        .getOrElse(Nil)
                ).mkString(" ")
            }">
            @maybeResults.map { x =>
                <span class="quiz__answer__icon">
                    @if(isAnswerCorrect) {
                        @inlineSvg("tick", "icon")
                    } else {
                        @maybeInputAnswer.map { inputAnswer =>
                            @if(inputAnswer.equals(answer)) {
                                @inlineSvg("cross", "icon")
                            }
                        }
                    }
                </span>
            }.getOrElse {
                <input type="radio"
                    name="answers[@questionIndex]"
                    id="question-@questionIndex-answer-@answerIndex"
                    value="Q@{questionIndex}##A@{answerIndex}##@{answer.text}"
                    class="quiz__answer__input">
            }
            <span class="quiz__answer__text">@{answer.text}</span>
            @maybeInputAnswer.map { inputAnswer =>
                @if(answer.revealText.isDefined && isAnswerCorrect && inputAnswer.equals(answer)) {
                    <span class="quiz__answer__reveal-text">@answer.revealText</span>
                }
            }
        </label>
    </div>
}
