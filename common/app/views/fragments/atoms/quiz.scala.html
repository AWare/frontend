@import _root_.model.content._
@import play.api.Play.current
@import play.api.i18n.Messages.Implicits._
@import views.html.fragments.inlineSvg

@(quiz: Quiz, maybeResults: Option[QuizSubmissionResult])

<h2>@quiz.title</h2>
<form action="@quiz.postUrl" method="POST" class="quiz">

    @quiz.questions.zipWithIndex.map { case (question, questionIndex) =>
        @renderQuestion(question, questionIndex, QuizForm.form(s"answers[$questionIndex]"))
    }
    @maybeResults match {
        case None => { <button class="button" type="submit">Submit answers</button> }
        case _ => {}
    }
</form>

@renderQuestion(question: _root_.model.content.Question, questionIndex: Int, field: play.api.data.Field) = {
    <fieldset class="quiz__question">
        <legend class="quiz__question-legend">
            <h4 class="quiz__question-legend__header">
                <span class="quiz__question-number">@{questionIndex+1}</span>
                <span class="quiz__question-text">@question.text</span>
            </h4>
        </legend>
        @question.answers.zipWithIndex.map { case (answer, answerIndex) =>
            @{
                val maybeInputAnswer = maybeResults.flatMap { results => {
                    results.entries
                        .find { case (inputQuestion, _) => inputQuestion.equals(question) }
                        .map(_._2)
                } }
                val isAnswerCorrect = quiz.isCorrectAnswer(question, answer)
                renderAnswer(question, answer, questionIndex, answerIndex, isAnswerCorrect, maybeInputAnswer)
            }
        }
    </fieldset>
}

@renderAnswer(question: Question, answer: Answer, questionIndex: Int, answerIndex: Int, isAnswerCorrect: Boolean, maybeInputAnswer: Option[Answer]) = {
    <div class="quiz__question__answer-row">
        <label for="question-@questionIndex-answer-@answerIndex"
            class="@{
                (
                    Seq("quiz__answer") ++
                    maybeResults
                        .map(x => Seq(s"quiz__answer--${if(isAnswerCorrect) { "correct" } else { "incorrect" }}"))
                        .getOrElse(Nil) ++
                    maybeInputAnswer
                        .map { inputAnswer => {
                            val isChosen = inputAnswer.equals(answer)
                            Seq(
                                "quiz__answer--has-answer",
                                if(isChosen) {
                                    s"quiz__answer--${if(isAnswerCorrect) { "correct" } else { "incorrect" }}--is-chosen"
                                } else ""
                            )
                        } }
                        .getOrElse(Nil)
                ).mkString(" ")
            }">
            @maybeResults.map { x =>
                <span class="quiz__answer-icon">
                    @if(isAnswerCorrect) {
                        @inlineSvg("tick", "icon", List("quiz__answer-icon-svg"))
                    } else {
                        @inlineSvg("cross", "icon", List("quiz__answer-icon-svg"))
                    }
                </span>
            }.getOrElse {
                <input type="radio"
                    name="answers[@questionIndex]"
                    id="question-@questionIndex-answer-@answerIndex"
                    value="Q@{questionIndex}##A@{answerIndex}##@{answer.text}"
                    class="quiz__answer__input">
            }
            @{answer.text}
        </label>
    </div>
}
