define([ 'common/common',
         'bean',
         'bonzo',
         'common/modules/adverts/article-body-adverts',
         'helpers/fixtures'
    ], function(common, bean, bonzo, ArticleBodyAdverts, fixtures) {


        describe("ArticleBodyAdverts", function() {
            var style;
            var articleBodyAdverts;
            var conf = {
                    id: 'article',
                    fixtures: [
                                '<div class="mpu-container js-mpu-ad-slot"><div class="social-wrapper social-wrapper--aside"><h2 class="article__meta-heading tone-colour">Share this article</h2></div></div>',
                                '<div class="article-body u-cf from-content-api" itemprop="articleBody"><h2>The winner</h2><p>Exactly a year ago, <a href="/film/movie/125622/hobbit" data-link-name="in body link" class=" u-underline">The Hobbit: An Unexpected Journey</a> opened in the UK with £9.51m, plus £2.1m in previews. Many critics carped that the film didnt live up to Peter Jacksons Lord of the Rings trilogy, and sounded a note of scepticism over <a href="/film/2013/dec/13/peter-jackson-48fps-tone-down-hobbit-desolation-smaug-hd" title="" data-link-name="in body link" class=" u-underline">the innovative 48 frames-per-second projection</a>. Still, audiences continued to embrace the film, and a final gross of £52.33m represented a healthy 5.5 multiple of the opening number – a relatively high ratio for a Hollywood blockbuster.</p><p>Now sequel <a href="/film/movie/154178/hobbit" title="" data-link-name="in body link" class=" u-underline">The Desolation of Smaug</a> arrives with a very similar £9.32m, slightly down on the original. A better Metacritic score of 66/100 (as opposed to 58/100 for Unexpected Journey) suggests that the film has found an easier ride from critics, and an IMDb user rating of 8.5/10 (8.0/10 for the earlier film) might indicate similar greater enthusiasm among cinemagoers. (A word of caution: the eager postings of early adopters can give an initial boost to IMDb user ratings, which then gradually decline as more film fans weigh in with their verdicts.)</p><p>Among films released in 2012, An Unexpected Journey ended up as the third-highest grosser, behind only Skyfall and The Dark Knight Rises. So far in 2013, the top title is <a href="/film/movie/155771/despicable-me-2" data-link-name="in body link" class=" u-underline">Despicable Me 2</a>, with £47.2m. Since no film has managed £50m this year (in 2012, there were four that passed that milestone), this means that The Desolation of Smaug has every chance of becoming the years top grosser – although of course it wont achieve this feat by 31 December. All will depend on how audiences respond to Smaug, and whether it can achieve a sustained, robust run like the one delivered by An Unexpected Journey.</p><p>Among films released in 2012, An Unexpected Journey ended up as the third-highest grosser, behind only Skyfall and The Dark Knight Rises. So far in 2013, the top title is <a href="/film/movie/155771/despicable-me-2" data-link-name="in body link" class=" u-underline">Despicable Me 2</a>, with £47.2m. Since no film has managed £50m this year (in 2012, there were four that passed that milestone), this means that The Desolation of Smaug has every chance of becoming the years top grosser – although of course it wont achieve this feat by 31 December. All will depend on how audiences respond to Smaug, and whether it can achieve a sustained, robust run like the one delivered by An Unexpected Journey.</p><p>Among films released in 2012, An Unexpected Journey ended up as the third-highest grosser, behind only Skyfall and The Dark Knight Rises. So far in 2013, the top title is <a href="/film/movie/155771/despicable-me-2" data-link-name="in body link" class=" u-underline">Despicable Me 2</a>, with £47.2m. Since no film has managed £50m this year (in 2012, there were four that passed that milestone), this means that The Desolation of Smaug has every chance of becoming the years top grosser – although of course it wont achieve this feat by 31 December. All will depend on how audiences respond to Smaug, and whether it can achieve a sustained, robust run like the one delivered by An Unexpected Journey.</p><p>With family films for the festive season, its not so much about the opening weekend as the full period up to Christmas Eve: virtually the whole of December can be golden. And that looks very much set to be the case with the animated film <a href="/film/movie/155770/frozen" title="" data-link-name="in body link" class=" u-underline">Frozen</a>. Having opened the previous frame with an impressive £4.7m, the Disney flick has delivered a sensational second session of £4.21m – a decline of just 11%. Among family films this year, not even Despicable Me 2 managed second-weekend takings above £4m.</p><p>After 10 days, Frozen has clocked up a very handy £10.3m, which compares with a similar £10.52m for Disneys Wreck-It Ralph at the same stage of its run, and £8.63m for Monsters University. Those films achieved final tallies of £23.78m and £30.64m respectively, and Disney will be hoping that Frozen lands at a similar place. And since there is no particular plot connection between Frozen and the Christmas holiday, there is no reason why the film couldnt continue to engage audiences beyond 25 December and into wintry January.</p><h2>The year to date</h2><p>This will be the final UK box-office report for 2013 – and in fact the column will be on a three-week hiatus – so it seems a good chance to take stock of the year. Below is a special one-off chart featuring the years top 30 hits. As usual, there is a strong domination by sequels and films based on existing hit properties, such as stage musical Les Misérables, comic-book icon Superman and books including The Great Gatsby and World War Z. <a href="/film/movie/156058/gravity" title="" data-link-name="in body link" class=" u-underline">Gravity</a> is a notable exception, repaying backers Warners $100m gamble on a potentially cerebral space drama with no pre-existing brand recognition. Sony, which has suffered some turmoil in 2013, achieved its biggest hits with a pair of original properties – <a href="/film/movie/154515/captain-phillips" title="" data-link-name="in body link" class=" u-underline">Captain Phillips</a> and <a href="/film/movie/144406/django-unchained" title="" data-link-name="in body link" class=" u-underline">Django Unchained</a> – unless you count Richard Phillips 2010 book or the 1966 film Django starring Franco Nero. Investors demanding a more blockbuster-driven strategy might pause to consider what actually worked for the studio.</p><div class="media-proportional-container"></div><p>Animation has had a particularly strong year in 2013. Not only is the top title (so far) Despicable Me 2, there are two more animations – <a href="/film/movie/155588/monsters-university" title="" data-link-name="in body link" class=" u-underline">Monsters University</a> and <a href="/film/movie/151435/croods" title="" data-link-name="in body link" class=" u-underline">The Croods</a> – in the years top 10, and <a href="/film/movie/150381/wreck-it-ralph" title="" data-link-name="in body link" class=" u-underline">Wreck-It Ralph</a> is just outside. Frozen should make a fifth animated feature at £20m-plus by years end.</p><p>Generating a lot of publicity – much of it negative – surrounding the casting of Britains Got Talent winner Susan Boyle, festive period tale <a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a> failed to engage cinema audiences in limited play. Released on a very modest 11 screens, the film achieved a gross of £7,747. Investors presumably hope the film will be a DVD gifting staple for older family members in years to come.</p><p>Generating a lot of publicity – much of it negative – surrounding the casting of Britains Got Talent winner Susan Boyle, festive period tale <a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a> failed to engage cinema audiences in limited play. Released on a very modest 11 screens, the film achieved a gross of £7,747. Investors presumably hope the film will be a DVD gifting staple for older family members in years to come.</p><p>Generating a lot of publicity – much of it negative – surrounding the casting of Britains Got Talent winner Susan Boyle, festive period tale <a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a> failed to engage cinema audiences in limited play. Released on a very modest 11 screens, the film achieved a gross of £7,747. Investors presumably hope the film will be a DVD gifting staple for older family members in years to come.</p><p>Generating a lot of publicity – much of it negative – surrounding the casting of Britains Got Talent winner Susan Boyle, festive period tale <a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a> failed to engage cinema audiences in limited play. Released on a very modest 11 screens, the film achieved a gross of £7,747. Investors presumably hope the film will be a DVD gifting staple for older family members in years to come.</p><p>Generating a lot of publicity – much of it negative – surrounding the casting of Britains Got Talent winner Susan Boyle, festive period tale <a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a> failed to engage cinema audiences in limited play. Released on a very modest 11 screens, the film achieved a gross of £7,747. Investors presumably hope the film will be a DVD gifting staple for older family members in years to come.</p><p>Overall the box office is a slim 1% up on the equivalent weekend from 2012, when the original Hobbit film and DreamWorks Animations Rise of the Guardians occupied the top two spots in the chart. This extends to four weeks a run where takings were up on the year-ago equivalent, following an eight-week run where box-office lagged behind 2012. Now cinema owners are hoping for a strong hold from both Smaug and Frozen, plus nice returns from the arrival on 18 December of <a href="/film/movie/155772/anchorman" title="" data-link-name="in body link" class=" u-underline">Anchorman 2: The Legend Continues</a>, followed on Friday by The Harry Hill Movie, Moshi Monsters and Walking with Dinosaurs. David O Russells acclaimed <a href="/film/movie/156243/american-hustle" title="" data-link-name="in body link" class=" u-underline">American Hustle</a> is in Londons West End only prior to its nationwide expansion on January 1. Arriving on Boxing Day are <a href="/film/movie/156523/secret-life-of-walter-mitty" title="" data-link-name="in body link" class=" u-underline">The Secret Life of Walter Mitty</a>, <a href="/film/movie/156242/47-ronin" title="" data-link-name="in body link" class=" u-underline">47 Ronin</a> and Robert Redford awards contender <a href="/film/movie/155232/all-is-lost" title="" data-link-name="in body link" class=" u-underline">All Is Lost</a>.</p><h2>Top 10 films 13-15 December</h2><p><strong>1.</strong><a href="/film/movie/154178/hobbit" title="" data-link-name="in body link" class=" u-underline">The Hobbit: The Desolation of Smaug</a>, £9,325,626 from 580 sites (<strong>New</strong>)</p><p><strong>2.</strong><a href="/film/movie/155770/frozen" title="" data-link-name="in body link" class=" u-underline">Frozen</a>, £4,212,920 from 515 sites. Total: £10,298,514</p><p><strong>3.</strong><a href="/film/movie/158612/hunger-games" title="" data-link-name="in body link" class=" u-underline">The Hunger Games: Catching Fire</a>, £1,368,662 from 492 sites. Total: £28,824,306</p><p><strong>4.</strong><a href="/film/movie/156058/gravity" title="" data-link-name="in body link" class=" u-underline">Gravity</a>, £592,321 from 359 sites. Total: £25,763,353</p><p><strong>5.</strong><a href="/film/movie/156373/saving-mr-banks" title="" data-link-name="in body link" class=" u-underline">Saving Mr Banks</a>, £359,134 from 393 sites. Total: £2,802,991</p><p><strong>6.</strong> Falstaff – Met Opera (live event), £224,763 from 165 sites (<strong>New</strong>)</p><p><strong>7.</strong><a href="/film/movie/158970/homefront" title="" data-link-name="in body link" class=" u-underline">Homefront</a>, £202,518 from 259 sites. Total: £942,561</p><p><strong>8.</strong><a href="/film/movie/156233/free-birds" title="" data-link-name="in body link" class=" u-underline">Free Birds</a>, £191,656 from 416 sites. Total: £1,788,256</p><p><strong>9.</strong><a href="/film/movie/155322/butler" title="" data-link-name="in body link" class=" u-underline">The Butler</a>, £144,573 from 207 sites. Total: £3,794,786</p><p><strong>10.</strong><a href="/film/movie/150238/carrie" title="" data-link-name="in body link" class=" u-underline">Carrie</a>, £118,097 from 224 sites. Total: £1,658,491</p><h2>Other openers</h2><p><a href="/film/movie/149866/fill-the-void" data-link-name="in body link" class=" u-underline">Fill the Void</a>, £24,740 from 7 sites</p><p><a href="/film/movie/76427/cinema.paradiso" data-link-name="in body link" class=" u-underline">Cinema Paradiso</a>, £12,374 from 17 sites (re-release)</p><p><a href="/film/movie/77279/innocents" data-link-name="in body link" class=" u-underline">The Innocents</a>, £10,056 from 8 sites</p><p><a href="/film/movie/158849/christmas-candle" data-link-name="in body link" class=" u-underline">The Christmas Candle</a>, £7,747 from 11 sites</p><p>Ivan Veramathiri, £5,866 from 5 sites</p><p>Tamam Miyiz?, £3,075 from 3 sites</p><p>Far Out Isnt Enough, £659 from 1 site</p><p>Sleeping Beauty – Opera de Paris, £542 from 1 site (live event)</p><p>Y Syrcas (The Circus), £406 from 1 site</p><p><a href="/film/movie/159072/tamla-rose" data-link-name="in body link" class=" u-underline">Tamla Rose</a>, no figures available</p><p>Thanks to Rentrak</p><h2>Top 30 UK films of 2013</h2><p><strong>1.</strong><a href="/film/movie/155771/despicable-me-2" title="" data-link-name="in body link" class=" u-underline">Despicable Me 2</a>, £47,346,102</p><p><strong>2.</strong><a href="/film/movie/150107/miserables" title="" data-link-name="in body link" class=" u-underline">Les Misérables</a>, £40,818,299</p><p><strong>3.</strong><a href="/film/movie/146938/iron-man-3" title="" data-link-name="in body link" class=" u-underline">Iron Man 3</a>, £36,965,265</p><p><strong>4.</strong><a href="/film/movie/155588/monsters-university" title="" data-link-name="in body link" class=" u-underline">Monsters University</a>, £30,638,138</p><p><strong>5.</strong><a href="/film/movie/148371/man-of-steel" title="" data-link-name="in body link" class=" u-underline">Man of Steel</a>, £29,950,865</p><p><strong>6. </strong><a href="/film/movie/158612/hunger-games" title="" data-link-name="in body link" class=" u-underline">The Hunger Games: Catching Fire</a>, £29,824,306</p><p><strong>7.</strong><a href="/film/movie/151435/croods" title="" data-link-name="in body link" class=" u-underline">The Croods</a>, £26,744,406</p><p><strong>8.</strong><a href="/film/movie/150829/star-trek-into-darkness" title="" data-link-name="in body link" class=" u-underline">Star Trek Into Darkness</a>, £25,821,010</p><p><strong>9.</strong><a href="/film/movie/156058/gravity" title="" data-link-name="in body link" class=" u-underline">Gravity</a>, £25,763,353</p><p><strong>10.</strong><a href="/film/movie/155252" title="" data-link-name="in body link" class=" u-underline">Fast &amp;Furious 6</a>, £25,274,986</p><p><strong>11.</strong><a href="/film/movie/150381/wreck-it-ralph" title="" data-link-name="in body link" class=" u-underline">Wreck-It Ralph</a>, £23,779,633</p><p><strong>12.</strong><a href="/film/movie/154500/thor" title="" data-link-name="in body link" class=" u-underline">Thor: The Dark World</a>, £19,711,938</p><p><strong>13.</strong><a href="/film/movie/155299/hangover-part-iii" title="" data-link-name="in body link" class=" u-underline">The Hangover: Part III</a>, £19,323,349</p><p><strong>14.</strong><a href="/film/movie/154515/captain-phillips" title="" data-link-name="in body link" class=" u-underline">Captain Phillips</a>, £15,805,169</p><p><strong>15.</strong><a href="/film/movie/150967/great-gatsby" title="" data-link-name="in body link" class=" u-underline">The Great Gatsby</a>, £15,737,351</p><p><strong>16.</strong><a href="/film/movie/144406/django-unchained" title="" data-link-name="in body link" class=" u-underline">Django Unchained</a>, £15,736,884</p><p><strong>17.</strong><a href="/film/movie/151291/oz-the-great-and-powerful" title="" data-link-name="in body link" class=" u-underline">Oz the Great and Powerful</a>, £15,275,896</p><p><strong>18.</strong><a href="/film/movie/154512/world-war-z" title="" data-link-name="in body link" class=" u-underline">World War Z</a>, £14,571,542</p><p><strong>19.</strong><a href="/film/movie/155263/epic" title="" data-link-name="in body link" class=" u-underline">Epic</a>, £13,736,822</p><p><strong>20.</strong><a href="/film/movie/156133/wolverine" title="" data-link-name="in body link" class=" u-underline">The Wolverine</a>, £13,698,405</p><p><strong>21.</strong><a href="/film/movie/148744/impossible" title="" data-link-name="in body link" class=" u-underline">The Impossible</a>, £13,259,615</p><p><strong>22.</strong><a href="/film/movie/156070/smurfs-2" title="" data-link-name="in body link" class=" u-underline">The Smurfs 2</a>, £12,383,573</p><p><strong>23.</strong><a href="/film/movie/156209/cloudy-with-a-chance-of-meatballs-2" title="" data-link-name="in body link" class=" u-underline">Cloudy With a Chance of Meatballs 2</a>, £11,865,720</p><p><strong>24.</strong><a href="/film/2013/oct/17/turbo-review" title="" data-link-name="in body link" class=" u-underline">Turbo</a>, £11,362,487</p><p><strong>25.</strong><a href="/film/movie/155486/now-you-see-me" title="" data-link-name="in body link" class=" u-underline">Now You See Me</a>, £11,128,459</p><p><strong>26.</strong><a href="/film/movie/150229/a-good-day-to-die-hard" title="" data-link-name="in body link" class=" u-underline">A Good Day to Die Hard</a>, £10,884,090</p><p><strong>27.</strong><a href="/film/movie/133030/oblivion" title="" data-link-name="in body link" class=" u-underline">Oblivion</a>, £10,649,592</p><p><strong>28.</strong><a href="/film/movie/156219/philomena" title="" data-link-name="in body link" class=" u-underline">Philomena</a>, £10,470,225</p><p><strong>29.</strong><a href="/film/movie/156145/the-conjuring" title="" data-link-name="in body link" class=" u-underline">The Conjuring</a>, £10,464,697</p><p><strong>30.</strong><a href="/film/movie/155770/frozen" title="" data-link-name="in body link" class=" u-underline">Frozen</a>, £10,298,514</p><p>Thanks to Universal, Disney, Sony, Warner Bros, Paramount, Fox, Lionsgate, eOne</p><p class=" bullet-container"><a href="/film/filmblog/2013/dec/16/hobbit-desolation-smaug-us-box-office" title="" data-link-name="in body link" class=" u-underline"><span class="bullet">•</span> US box office: The Hobbit leaves Frozen out in the cold</a></p><p class=" bullet-container"><a href="/film/video/2013/dec/16/hobbit-desolation-of-smaug-martin-freeman-benedict-cumberbatch-video-interviews" title="" data-link-name="in body link" class=" u-underline"><span class="bullet">•</span> The Hobbit – interviews with Martin Freeman, Evangeline Lilly and Benedict Cumberbatch</a></p></div>'
                              ]
            };

            beforeEach(function() {
                fixtures.render(conf);

                articleBodyAdverts = new ArticleBodyAdverts({
                });

                style = bonzo(bonzo.create('<style type="text/css"></style>'))
                    .html('body:after{ content: "wide"}')
                    .appendTo('head');
            });

            afterEach(function() {
                fixtures.clean();
                style.remove();
                articleBodyAdverts.destroyAds();
            });

            it("Should insert an ad container in the secondary column", function() {
                articleBodyAdverts.init();
                expect(document.querySelectorAll('.ad-slot--mpu-banner-ad').length).toBe(1);
            });

            it("Should insert an 2 inline ad containers to the content", function() {
                articleBodyAdverts.init();
                expect(document.querySelectorAll('.ad-slot--inline').length).toBe(2);
            });

            it("Should insert an ad container after a H2 tag", function() {
                articleBodyAdverts.init();
                expect(document.querySelectorAll('.ad-slot--inline')[0].previousElementSibling.nodeName).toBe('H2');
            });

            it("Should NOT insert an ad container after a H2 tag when on a mobile device", function() {
                style.remove();

                style = bonzo(bonzo.create('<style type="text/css"></style>'))
                    .html('body:after{ content: "mobile"}')
                    .appendTo('head');

                articleBodyAdverts.init();
                expect(document.querySelectorAll('.ad-slot--inline')[0].previousElementSibling.nodeName).toBe('P');
            });

            it("Should destroy the ads", function() {
                articleBodyAdverts.init();
                expect(document.querySelectorAll('.ad-slot--mpu-banner-ad, .ad-slot--inline').length).toBe(3);

                articleBodyAdverts.destroyAds();
                expect(document.querySelectorAll('.ad-slot--mpu-banner-ad, .ad-slot--inline').length).toBe(0);
            });
        });
    });
